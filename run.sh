set -euo pipefail

# 1. Python and Node deps

python3 -m pip install --upgrade pip
python3 -m pip install -r apps/api/requirements.txt

cd apps/web
npm install
npm run build
cd ../..

# 2. Ensure data dir

mkdir -p data

# 3. Install raw Genesis 1-5 if not present, then normalize and lock

if [ ! -f data/gen_1_5_raw.txt ]; then
cat > data/gen_1_5_raw.txt << 'EOF_RAW'
Genesis, Chapter 1
1:1 בראשׁית ברא אלהים את השׁמים ואת הארץ׃
1:2 והארץ היתה תהו ובהו וחשׁך על־פני תהום ורוח אלהים מרחפת על־פני המים׃
1:3 ויאמר אלהים יהי אור ויהי־אור׃
1:4 וירא אלהים את־האור כי־טוב ויבדל אלהים בין האור ובין החשׁך׃
1:5 ויקרא אלהים ׀ לאור יום ולחשׁך קרא לילה ויהי־ערב ויהי־בקר יום אחד׃ פ
1:6 ויאמר אלהים יהי רקיע בתוך המים ויהי מבדיל בין מים למים׃
1:7 ויעשׂ אלהים את־הרקיע ויבדל בין המים אשׁר מתחת לרקיע ובין המים אשׁר מעל לרקיע ויהי־כן׃
1:8 ויקרא אלהים לרקיע שׁמים ויהי־ערב ויהי־בקר יום שׁני׃ פ
1:9 ויאמר אלהים יקוו המים מתחת השׁמים אל־מקום אחד ותראה היבשׁה ויהי־כן׃
1:10 ויקרא אלהים ׀ ליבשׁה ארץ ולמקוה המים קרא ימים וירא אלהים כי־טוב׃
1:11 ויאמר אלהים תדשׁא הארץ דשׁא עשׂב מזריע זרע עץ פרי עשׂה פרי למינו אשׁר זרעו־בו על־הארץ ויהי־כן׃
1:12 ותוצא הארץ דשׁא עשׂב מזריע זרע למינהו ועץ עשׂה־פרי  אשׁר זרעו־בו למינהו וירא אלהים כי־טוב׃
1:13 ויהי־ערב ויהי־בקר יום שׁלישׁי׃ פ
1:14 ויאמר אלהים יהי מארת ברקיע השׁמים להבדיל בין היום ובין הלילה והיו לאתת ולמועדים ולימים ושׁנים׃
1:15 והיו למאורת ברקיע השׁמים להאיר על־הארץ ויהי־כן׃
1:16 ויעשׂ אלהים את־שׁני המארת הגדלים את־המאור הגדל לממשׁלת היום ואת־המאור הקטן לממשׁלת הלילה ואת הכוכבים׃
1:17 ויתן אתם אלהים ברקיע השׁמים להאיר על־הארץ׃
1:18 ולמשׁל ביום ובלילה ולהבדיל בין האור ובין החשׁך וירא אלהים כי־טוב׃
1:19 ויהי־ערב ויהי־בקר יום רביעי׃ פ
1:20 ויאמר אלהים ישׁרצו המים שׁרץ נפשׁ חיה ועוף יעופף על־הארץ על־פני רקיע השׁמים׃
1:21 ויברא אלהים את־התנינם הגדלים ואת כל־נפשׁ החיה ׀ הרמשׂת אשׁר שׁרצו המים למינהם ואת כל־עוף כנף למינהו וירא אלהים כי־טוב׃
1:22 ויברך אתם אלהים לאמר פרו ורבו ומלאו את־המים בימים והעוף ירב בארץ׃
1:23 ויהי־ערב ויהי־בקר יום חמישׁי׃ פ
1:24 ויאמר אלהים תוצא הארץ נפשׁ חיה למינה בהמה ורמשׂ וחיתו־ארץ למינה ויהי־כן׃
1:25 ויעשׂ אלהים את־חית הארץ למינה ואת־הבהמה למינה ואת כל־רמשׂ האדמה למינהו וירא אלהים כי־טוב׃
1:26 ויאמר אלהים נעשׂה אדם בצלמנו כדמותנו וירדו בדגת הים ובעוף השׁמים ובבהמה ובכל־הארץ ובכל־הרמשׂ הרמשׂ על־הארץ׃
1:27 ויברא אלהים ׀ את־האדם בצלמו בצלם אלהים ברא אתו זכר ונקבה ברא אתם׃
1:28 ויברך אתם אלהים ויאמר להם אלהים פרו ורבו ומלאו את־הארץ וכבשׁה ורדו בדגת הים ובעוף השׁמים ובכל־חיה הרמשׂת על־הארץ׃
1:29 ויאמר אלהים הנה נתתי לכם את־כל־עשׂב ׀ זרע זרע אשׁר על־פני כל־הארץ ואת־כל־העץ אשׁר־בו פרי־עץ זרע זרע לכם יהיה לאכלה׃
1:30 ולכל־חית הארץ ולכל־עוף השׁמים ולכל ׀ רומשׂ על־הארץ אשׁר־בו נפשׁ חיה את־כל־ירק עשׂב לאכלה ויהי־כן׃
1:31 וירא אלהים את־כל־אשׁר עשׂה והנה־טוב מאד ויהי־ערב ויהי־בקר יום השׁשׁי׃ פ

Genesis, Chapter 2
2:1 ויכלו השׁמים והארץ וכל־צבאם׃
2:2 ויכל אלהים ביום השׁביעי מלאכתו אשׁר עשׂה וישׁבת ביום השׁביעי מכל־מלאכתו אשׁר עשׂה׃
2:3 ויברך אלהים את־יום השׁביעי ויקדשׁ אתו כי בו שׁבת מכל־מלאכתו אשׁר־ברא אלהים לעשׂות׃ פ
2:4 אלה תולדות השׁמים והארץ בהבראם ביום עשׂות יהוה אלהים ארץ ושׁמים׃
2:5 וכל ׀ שׂיח השׂדה טרם יהיה בארץ וכל־עשׂב השׂדה טרם יצמח כי לא המטיר יהוה אלהים על־הארץ ואדם אין לעבד את־האדמה׃
2:6 ואד יעלה מן־הארץ והשׁקה את־כל־פני־האדמה׃
2:7 וייצר יהוה אלהים את־האדם עפר מן־האדמה ויפח באפיו נשׁמת חיים ויהי האדם לנפשׁ חיה׃
2:8 ויטע יהוה אלהים גן־בעדן מקדם וישׂם שׁם את־האדם אשׁר יצר׃
2:9 ויצמח יהוה אלהים מן־האדמה כל־עץ נחמד למראה וטוב למאכל ועץ החיים בתוך הגן ועץ הדעת טוב ורע׃
2:10 ונהר יצא מעדן להשׁקות את־הגן ומשׁם יפרד והיה לארבעה ראשׁים׃
2:11 שׁם האחד פישׁון הוא הסבב את כל־ארץ החוילה אשׁר־שׁם הזהב׃
2:12 וזהב הארץ ההוא טוב שׁם הבדלח ואבן השׁהם׃
2:13 ושׁם־הנהר השׁני גיחון הוא הסובב את כל־ארץ כושׁ׃
2:14 ושׁם הנהר השׁלישׁי חדקל הוא ההלך קדמת אשׁור והנהר הרביעי הוא פרת׃
2:15 ויקח יהוה אלהים את־האדם וינחהו בגן־עדן לעבדה ולשׁמרה׃
2:16 ויצו יהוה אלהים על־האדם לאמר מכל עץ־הגן אכל תאכל׃
2:17 ומעץ הדעת טוב ורע לא תאכל ממנו כי ביום אכלך ממנו מות תמות׃
2:18 ויאמר יהוה אלהים לא־טוב היות האדם לבדו אעשׂה־לו עזר כנגדו׃
2:19 ויצר יהוה אלהים מן־האדמה כל־חית השׂדה ואת כל־עוף השׁמים ויבא אל־האדם לראות מה־יקרא־לו וכל אשׁר יקרא־לו האדם נפשׁ חיה הוא שׁמו׃
2:20 ויקרא האדם שׁמות לכל־הבהמה ולעוף השׁמים ולכל חית השׂדה ולאדם לא־מצא עזר כנגדו׃
2:21 ויפל יהוה אלהים ׀ תרדמה על־האדם ויישׁן ויקח אחת מצלעתיו ויסגר בשׂר תחתנה׃
2:22 ויבן יהוה אלהים ׀ את־הצלע אשׁר־לקח מן־האדם לאשׁה ויבאה אל־האדם׃
2:23 ויאמר האדם זאת הפעם עצם מעצמי ובשׂר מבשׂרי לזאת יקרא אשׁה כי מאישׁ לקחה־זאת׃
2:24 על־כן יעזב־אישׁ את־אביו ואת־אמו ודבק באשׁתו והיו לבשׂר אחד׃
2:25 ויהיו שׁניהם ערומים האדם ואשׁתו ולא יתבשׁשׁו׃

Genesis, Chapter 3
3:1 והנחשׁ היה ערום מכל חית השׂדה אשׁר עשׂה יהוה אלהים ויאמר אל־האשׁה אף כי־אמר אלהים לא תאכלו מכל עץ הגן׃
3:2 ותאמר האשׁה אל־הנחשׁ מפרי עץ־הגן נאכל׃
3:3 ומפרי העץ אשׁר בתוך־הגן אמר אלהים לא תאכלו ממנו ולא תגעו בו פן־תמתון׃
3:4 ויאמר הנחשׁ אל־האשׁה לא־מות תמתון׃
3:5 כי ידע אלהים כי ביום אכלכם ממנו ונפקחו עיניכם והייתם כאלהים ידעי טוב ורע׃
3:6 ותרא האשׁה כי טוב העץ למאכל וכי תאוה־הוא לעינים ונחמד העץ להשׂכיל ותקח מפריו ותאכל ותתן גם־לאישׁה עמה ויאכל׃
3:7 ותפקחנה עיני שׁניהם וידעו כי עירמם הם ויתפרו עלה תאנה ויעשׂו להם חגרת׃
3:8 וישׁמעו את־קול יהוה אלהים מתהלך בגן לרוח היום ויתחבא האדם ואשׁתו מפני יהוה אלהים בתוך עץ הגן׃
3:9 ויקרא יהוה אלהים אל־האדם ויאמר לו איכה׃
3:10 ויאמר את־קלך שׁמעתי בגן ואירא כי־עירם אנכי ואחבא׃
3:11 ויאמר מי הגיד לך כי עירם אתה המן־העץ אשׁר צויתיך לבלתי אכל־ממנו אכלת׃
3:12 ויאמר האדם האשׁה אשׁר נתתה עמדי הוא נתנה־לי מן־העץ ואכל׃
3:13 ויאמר יהוה אלהים לאשׁה מה־זאת עשׂית ותאמר האשׁה הנחשׁ השׁיאני ואכל׃
3:14 ויאמר יהוה אלהים ׀ אל־הנחשׁ כי עשׂית זאת ארור אתה מכל־הבהמה ומכל חית השׂדה על־גחנך תלך ועפר תאכל כל־ימי חייך׃
3:15 ואיבה ׀ אשׁית בינך ובין האשׁה ובין זרעך ובין זרעה הוא ישׁופך ראשׁ ואתה תשׁופנו עקב׃ ס
3:16 אל־האשׁה אמר הרבה ארבה עצבונך והרנך בעצב תלדי בנים ואל־אישׁך תשׁוקתך והוא ימשׁל־בך׃ ס
3:17 ולאדם אמר כי־שׁמעת לקול אשׁתך ותאכל מן־העץ אשׁר צויתיך לאמר לא תאכל ממנו ארורה האדמה בעבורך בעצבון תאכלנה כל ימי חייך׃
3:18 וקוץ ודרדר תצמיח לך ואכלת את־עשׂב השׂדה׃
3:19 בזעת אפיך תאכל לחם עד שׁובך אל־האדמה כי ממנה לקחת כי־עפר אתה ואל־עפר תשׁוב׃
3:20 ויקרא האדם שׁם אשׁתו חוה כי הוא היתה אם כל־חי׃
3:21 ויעשׂ יהוה אלהים לאדם ולאשׁתו כתנות עור וילבשׁם׃ פ
3:22 ויאמר ׀ יהוה אלהים הן האדם היה כאחד ממנו לדעת טוב ורע ועתה ׀ פן־ישׁלח ידו ולקח גם מעץ החיים ואכל וחי לעלם׃
3:23 וישׁלחהו יהוה אלהים מגן־עדן לעבד את־האדמה אשׁר לקח משׁם׃
3:24 ויגרשׁ את־האדם וישׁכן מקדם לגן־עדן את־הכרבים ואת להט החרב המתהפכת לשׁמר את־דרך עץ החיים׃ ס

Genesis, Chapter 4
4:1 והאדם ידע את־חוה אשׁתו ותהר ותלד את־קין ותאמר קניתי אישׁ את־יהוה׃
4:2 ותסף ללדת את־אחיו את־הבל ויהי־הבל רעה צאן וקין היה עבד אדמה׃
4:3 ויהי מקץ ימים ויבא קין מפרי האדמה מנחה ליהוה׃
4:4 והבל הביא גם־הוא מבכרות צאנו ומחלבהן וישׁע יהוה אל־הבל ואל־מנחתו׃
4:5 ואל־קין ואל־מנחתו לא שׁעה ויחר לקין מאד ויפלו פניו׃
4:6 ויאמר יהוה אל־קין למה חרה לך ולמה נפלו פניך׃
4:7 הלוא אם־תיטיב שׂאת ואם לא תיטיב לפתח חטאת רבץ ואליך תשׁוקתו ואתה תמשׁל־בו׃
4:8 ויאמר קין אל־הבל אחיו ויהי בהיותם בשׂדה ויקם קין אל־הבל אחיו ויהרגהו׃
4:9 ויאמר יהוה אל־קין אי הבל אחיך ויאמר לא ידעתי השׁמר אחי אנכי׃
4:10 ויאמר מה עשׂית קול דמי אחיך צעקים אלי מן־האדמה׃
4:11 ועתה ארור אתה מן־האדמה אשׁר פצתה את־פיה לקחת את־דמי אחיך מידך׃
4:12 כי תעבד את־האדמה לא־תסף תת־כחה לך נע ונד תהיה בארץ׃
4:13 ויאמר קין אל־יהוה גדול עוני מנשׂא׃
4:14 הן גרשׁת אתי היום מעל פני האדמה ומפניך אסתר והייתי נע ונד בארץ והיה כל־מצאי יהרגני׃
4:15 ויאמר לו יהוה לכן כל־הרג קין שׁבעתים יקם וישׂם יהוה לקין אות לבלתי הכות־אתו כל־מצאו׃
4:16 ויצא קין מלפני יהוה וישׁב בארץ־נוד קדמת־עדן׃
4:17 וידע קין את־אשׁתו ותהר ותלד את־חנוך ויהי בנה עיר ויקרא שׁם העיר כשׁם בנו חנוך׃
4:18 ויולד לחנוך את־עירד ועירד ילד את־מחויאל ומחייאל ילד את־מתושׁאל ומתושׁאל ילד את־למך׃
4:19 ויקח־לו למך שׁתי נשׁים שׁם האחת עדה ושׁם השׁנית צלה׃
4:20 ותלד עדה את־יבל הוא היה אבי ישׁב אהל ומקנה׃
4:21 ושׁם אחיו יובל הוא היה אבי כל־תפשׂ כנור ועוגב׃
4:22 וצלה גם־הוא ילדה את־תובל קין לטשׁ כל־חרשׁ נחשׁת וברזל ואחות תובל־קין נעמה׃
4:23 ויאמר למך לנשׁיו עדה וצלה שׁמען קולי נשׁי למך האזנה אמרתי כי אישׁ הרגתי לפצעי וילד לחברתי׃
4:24 כי שׁבעתים יקם־קין ולמך שׁבעים ושׁבעה׃
4:25 וידע אדם עוד את־אשׁתו ותלד בן ותקרא את־שׁמו שׁת כי שׁת־לי אלהים זרע אחר תחת הבל כי הרגו קין׃
4:26 ולשׁת גם־הוא ילד־בן ויקרא את־שׁמו אנושׁ אז הוחל לקרא בשׁם יהוה׃ פ

Genesis, Chapter 5
5:1 זה ספר תולדת אדם ביום ברא אלהים אדם בדמות אלהים עשׂה אתו׃
5:2 זכר ונקבה בראם ויברך אתם ויקרא את־שׁמם אדם ביום הבראם׃ ס
5:3 ויחי אדם שׁלשׁים ומאת שׁנה ויולד בדמותו כצלמו ויקרא את־שׁמו שׁת׃
5:4 ויהיו ימי־אדם אחרי הולידו את־שׁת שׁמנה מאת שׁנה ויולד בנים ובנות׃
5:5 ויהיו כל־ימי אדם אשׁר־חי תשׁע מאות שׁנה ושׁלשׁים שׁנה וימת׃ ס
5:6 ויחי־שׁת חמשׁ שׁנים ומאת שׁנה ויולד את־אנושׁ׃
5:7 ויחי־שׁת אחרי הולידו את־אנושׁ שׁבע שׁנים ושׁמנה מאות שׁנה ויולד בנים ובנות׃
5:8 ויהיו כל־ימי־שׁת שׁתים עשׂרה שׁנה ותשׁע מאות שׁנה וימת׃ ס
5:9 ויחי אנושׁ תשׁעים שׁנה ויולד את־קינן׃
5:10 ויחי אנושׁ אחרי הולידו את־קינן חמשׁ עשׂרה שׁנה ושׁמנה מאות שׁנה ויולד בנים ובנות׃
5:11 ויהיו כל־ימי אנושׁ חמשׁ שׁנים ותשׁע מאות שׁנה וימת׃ ס
5:12 ויחי קינן שׁבעים שׁנה ויולד את־מהללאל׃
5:13 ויחי קינן אחרי הולידו את־מהללאל ארבעים שׁנה ושׁמנה מאות שׁנה ויולד בנים ובנות׃
5:14 ויהיו כל־ימי קינן עשׂר שׁנים ותשׁע מאות שׁנה וימת׃ ס
5:15 ויחי מהללאל חמשׁ שׁנים ושׁשׁים שׁנה ויולד את־ירד׃
5:16 ויחי מהללאל אחרי הולידו את־ירד שׁלשׁים שׁנה ושׁמנה מאות שׁנה ויולד בנים ובנות׃
5:17 ויהיו כל־ימי מהללאל חמשׁ ותשׁעים שׁנה ושׁמנה מאות שׁנה וימת׃ ס
5:18 ויחי־ירד שׁתים ושׁשׁים שׁנה ומאת שׁנה ויולד את־חנוך׃
5:19 ויחי־ירד אחרי הולידו את־חנוך שׁמנה מאות שׁנה ויולד בנים ובנות׃
5:20 ויהיו כל־ימי־ירד שׁתים ושׁשׁים שׁנה ותשׁע מאות שׁנה וימת׃ פ
5:21 ויחי חנוך חמשׁ ושׁשׁים שׁנה ויולד את־מתושׁלח׃
5:22 ויתהלך חנוך את־האלהים אחרי הולידו את־מתושׁלח שׁלשׁ מאות שׁנה ויולד בנים ובנות׃
5:23 ויהי כל־ימי חנוך חמשׁ ושׁשׁים שׁנה ושׁלשׁ מאות שׁנה׃
5:24 ויתהלך חנוך את־האלהים ואיננו כי־לקח אתו אלהים׃ פ
5:25 ויחי מתושׁלח שׁבע ושׁמנים שׁנה ומאת שׁנה ויולד את־למך׃
5:26 ויחי מתושׁלח אחרי הולידו את־למך שׁתים ושׁמונים שׁנה ושׁבע מאות שׁנה ויולד בנים ובנות׃
5:27 ויהיו כל־ימי מתושׁלח תשׁע ושׁשׁים שׁנה ותשׁע מאות שׁנה וימת׃ פ
5:28 ויחי־למך שׁתים ושׁמנים שׁנה ומאת שׁנה ויולד בן׃
5:29 ויקרא את־שׁמו נח לאמר זה ינחמנו ממעשׂנו ומעצבון ידינו מן־האדמה אשׁר אררה יהוה׃
5:30 ויחי־למך אחרי הולידו את־נח חמשׁ ותשׁעים שׁנה וחמשׁ מאת שׁנה ויולד בנים ובנות׃
5:31 ויהי כל־ימי־למך שׁבע ושׁבעים שׁנה ושׁבע מאות שׁנה וימת׃ ס
5:32 ויהי־נח בן־חמשׁ מאות שׁנה ויולד נח את־שׁם את־חם ואת־יפת׃
EOF_RAW
fi

python3 - << 'PY'
import pathlib, regex as re, hashlib, json, sys

raw_p = pathlib.Path('data/gen_1_5_raw.txt')
norm_p = pathlib.Path('data/genesis_1_5_consonants.txt')
lock_p = pathlib.Path('data/genesis_1_5.lock')

raw = raw_p.read_text(encoding='utf-8')

# strip combining marks

t = re.sub(r'[\p{Mn}]+','', raw)

# keep Hebrew letters only

t = re.sub(r'[^\p{Hebrew}]','', t)

sha_raw = hashlib.sha256(raw.encode('utf-8')).hexdigest()
sha_norm = hashlib.sha256(t.encode('utf-8')).hexdigest()
letters = len(t)

if norm_p.exists() and lock_p.exists():
lock = json.loads(lock_p.read_text(encoding='utf-8'))
if lock.get('sha_raw') != sha_raw or lock.get('sha_norm') != sha_norm or lock.get('letters') != letters:
sys.stderr.write('Source lock mismatch. Refusing to run. Update aborted.\n')
sys.exit(1)

norm_p.write_text(t, encoding='utf-8')
lock_p.write_text(json.dumps({'sha_raw': sha_raw, 'sha_norm': sha_norm, 'letters': letters}, ensure_ascii=False, indent=2), encoding='utf-8')

print('Genesis 1-5 normalized.')
print('Letters:', letters)
print('RAW  SHA256:', sha_raw)
print('NORM SHA256:', sha_norm)
PY

# 4. Start API on 8000 serving UI build

python3 -m uvicorn apps.api.app.main:app --host 0.0.0.0 --port 8000
